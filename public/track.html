<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Suivi de course - TuniDrive</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', Arial, sans-serif; background: #0b0b0b; color: #fff; }
    #header { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 10px 14px; }
    #status { font-size: 13px; opacity: 0.85; }
    #map { position: absolute; top: 52px; bottom: 0; left: 0; right: 0; }
    .pill { padding: 6px 10px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 999px; font-size: 12px; color: #cfcfcf; }
    .brand { font-weight: 700; letter-spacing: 0.3px; }
    .badge { padding: 4px 8px; border-radius: 8px; font-size: 12px; border: 1px solid #2a2a2a; background: #111; color: #aaa; }
    a { color: #61dafb; text-decoration: none; }
  </style>
</head>
<body>
  <div id="header">
    <div class="brand">TuniDrive ‚Ä¢ Suivi de course</div>
    <div id="status" class="badge">Initialisation‚Ä¶</div>
  </div>
  <div id="map"></div>

  <script src="./track-config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    console.log('üöÄ Script de tracking d√©marr√©');
    
    let map;
    let vehicleMarker;
    let lastPosition = null;
    let supa;
    let channel = null;

    function setStatus(text) {
      console.log('üìù Changement de statut:', text);
      document.getElementById('status').textContent = text;
    }

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    async function loadConfig() {
      console.log('üîç Tentative de chargement depuis Netlify Function...');
      try {
        const resp = await fetch('/.netlify/functions/public-config', { cache: 'no-store' });
        if (resp.ok) {
          const json = await resp.json();
          if (json && json.VITE_SUPABASE_URL && json.VITE_SUPABASE_ANON_KEY) {
            console.log('‚úÖ Configuration trouv√©e via Netlify Function');
            return {
              supabaseUrl: json.VITE_SUPABASE_URL,
              supabaseAnonKey: json.VITE_SUPABASE_ANON_KEY,
              googleMapsApiKey: json.VITE_GOOGLE_MAPS_API_KEY,
            };
          }
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è Netlify public-config indisponible, utilisation du fallback:', e);
      }
      
      if (window.TRACK_CONFIG && window.TRACK_CONFIG.supabaseUrl && window.TRACK_CONFIG.supabaseAnonKey) {
        console.log('‚úÖ Configuration trouv√©e via window.TRACK_CONFIG');
        return {
          supabaseUrl: window.TRACK_CONFIG.supabaseUrl,
          supabaseAnonKey: window.TRACK_CONFIG.supabaseAnonKey,
          googleMapsApiKey: window.TRACK_CONFIG.googleMapsApiKey,
        };
      }
      
      console.log('‚ùå Aucune configuration trouv√©e');
      return null;
    }

    function updateMarker(lat, lng, heading) {
      const position = { lat, lng };
      
      if (!vehicleMarker) {
        // Cr√©er le marqueur avec ic√¥ne personnalis√©e
        vehicleMarker = new google.maps.Marker({
          position: position,
          map: map,
          title: 'V√©hicule',
          icon: {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 6,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            rotation: heading || 0
          }
        });
        
        // Centrer la carte sur la position
        map.setCenter(position);
        map.setZoom(15);
      } else {
        // Mettre √† jour la position et la rotation
        vehicleMarker.setPosition(position);
        if (heading !== undefined) {
          vehicleMarker.setIcon({
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 6,
            fillColor: '#4285F4',
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
            rotation: heading
          });
        }
      }
      
      lastPosition = { lat, lng, heading: heading || 0 };
    }

    function subscribeToTracking() {
      const token = getQueryParam('token');
      if (!token) {
        setStatus('Aucun token de suivi fourni.');
        alert('Param√®tre manquant: ?token=...');
        return;
      }

      console.log('üîç D√©but de la souscription au canal...');
      setStatus('Connexion au canal‚Ä¶');
      const channelName = `tracking:${token}`;
      channel = supa.channel(channelName, { config: { broadcast: { self: false } } });

      channel.on('broadcast', { event: 'position' }, (payload) => {
        const data = payload?.payload || {};
        const { lat, lng, heading, speed, ts } = data;
        if (typeof lat === 'number' && typeof lng === 'number') {
          updateMarker(lat, lng, heading);
          const speedKmh = typeof speed === 'number' ? (speed * 3.6).toFixed(0) : '‚Äî';
          const time = ts ? new Date(ts).toLocaleTimeString() : '';
          setStatus(`En direct ‚Ä¢ ${lat.toFixed(5)}, ${lng.toFixed(5)} ‚Ä¢ ${speedKmh} km/h ${time ? '‚Ä¢ ' + time : ''}`);
        }
      });

      channel.subscribe((status) => {
        console.log('üîç Statut de souscription:', status);
        if (status === 'SUBSCRIBED') {
          setStatus('En direct ‚Ä¢ en attente de position‚Ä¶');
          console.log('‚úÖ Canal souscrit avec succ√®s');
        } else if (status === 'CHANNEL_ERROR') {
          setStatus('Erreur de canal. Reconnexion‚Ä¶');
          console.error('‚ùå Erreur de canal');
        } else if (status === 'TIMED_OUT') {
          setStatus('D√©lai d√©pass√©. Reconnexion‚Ä¶');
          console.warn('‚ö†Ô∏è D√©lai d√©pass√©');
        } else if (status === 'CLOSED') {
          setStatus('Canal ferm√©. Tentative de reconnexion‚Ä¶');
          console.warn('‚ö†Ô∏è Canal ferm√©');
        }
      });
    }

    async function loadGoogleMapsScript(apiKey) {
      return new Promise((resolve, reject) => {
        if (window.google && window.google.maps) {
          resolve();
          return;
        }

        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initGoogleMaps`;
        script.async = true;
        script.defer = true;
        
        window.initGoogleMaps = () => {
          console.log('‚úÖ Google Maps charg√© avec succ√®s');
          resolve();
        };
        
        script.onerror = () => {
          console.error('‚ùå Erreur lors du chargement de Google Maps');
          reject(new Error('Impossible de charger Google Maps'));
        };
        
        document.head.appendChild(script);
      });
    }

    async function initMap() {
      console.log('üó∫Ô∏è Initialisation de Google Maps...');
      
      // Charger la configuration d'abord
      const cfg = await loadConfig();
      if (!cfg) {
        setStatus('Configuration manquante.');
        console.error('Aucune configuration disponible.');
        return;
      }

      if (!cfg.googleMapsApiKey) {
        setStatus('Cl√© API Google Maps manquante.');
        console.error('VITE_GOOGLE_MAPS_API_KEY non configur√©e.');
        return;
      }

      // Charger Google Maps avec la cl√© API
      try {
        await loadGoogleMapsScript(cfg.googleMapsApiKey);
      } catch (error) {
        setStatus('Erreur: Impossible de charger Google Maps');
        console.error('Erreur Google Maps:', error);
        return;
      }
      
      // Configuration de la carte
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 36.8065, lng: 10.1815 }, // Tunis par d√©faut
        zoom: 12,
        styles: [
          {
            featureType: 'all',
            elementType: 'geometry.fill',
            stylers: [{ color: '#2d3748' }]
          },
          {
            featureType: 'water',
            elementType: 'geometry.fill',
            stylers: [{ color: '#1a365d' }]
          },
          {
            featureType: 'road',
            elementType: 'geometry.fill',
            stylers: [{ color: '#4a5568' }]
          },
          {
            featureType: 'poi',
            elementType: 'labels.text.fill',
            stylers: [{ color: '#a0aec0' }]
          }
        ]
      });

      // Initialiser Supabase
      if (!window.supabase) {
        setStatus('Erreur: Supabase non charg√©');
        console.error('window.supabase is undefined.');
        return;
      }

      supa = window.supabase.createClient(
        cfg.supabaseUrl,
        cfg.supabaseAnonKey,
        { realtime: { params: { eventsPerSecond: 10 } } }
      );

      // Se connecter et s'abonner
      supa.realtime.connect();
      subscribeToTracking();
    }

    // Exposer initMap globalement pour le callback Google Maps
    window.initMap = initMap;
  </script>
</body>
</html>