<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©initialisation de mot de passe - TuniDrive</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        .logo {
            font-size: 32px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            color: #333;
            font-size: 16px;
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 20px;
            padding: 15px;
            background: #fee;
            border-radius: 8px;
            border: 1px solid #e74c3c;
        }
        
        .button {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <img class="logo" src="https://tunidrive.net/tunidrive-logo.png" alt="TuniDrive" loading="eager" fetchpriority="high">
		<div class="logo">TuniDrive</div>
		<div class="spinner" id="spinner"></div>
		<div class="message" id="message">Pr√©paration du formulaire de r√©initialisation...</div>
        <div id="error" class="error" style="display: none;"></div>

		<!-- Formulaire de r√©initialisation (affich√© quand la session recovery est pr√™te) -->
		<form id="form" style="display: none; margin-top: 16px; text-align: left;">
			<label style="font-weight: 600;">Nouveau mot de passe</label>
			<input id="pwd" type="password" placeholder="Nouveau mot de passe" required
				style="display:block;width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:8px;" />

			<label style="font-weight: 600;margin-top:12px;display:block;">Confirmer le mot de passe</label>
			<input id="pwd2" type="password" placeholder="Confirmer le mot de passe" required
				style="display:block;width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:8px;" />

			<button type="submit" class="button" style="width:100%;margin-top:16px;">Mettre √† jour le mot de passe</button>
		</form>

		<!-- Message succ√®s -->
		<div id="success" class="message" style="display:none;margin-top:16px;">
			‚úÖ Votre mot de passe a √©t√© r√©initialis√© avec succ√®s. Vous pouvez maintenant ouvrir l'application TuniDrive et vous connecter avec votre nouveau mot de passe.
		</div>
    </div>

	<!-- Supabase JS (CDN) -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function() {
            try {
				console.log('üîó Page de r√©initialisation de mot de passe charg√©e');
				console.log('üìç URL compl√®te:', window.location.href);

				// D√©terminer le type d'utilisateur (client/driver) depuis les query params
				var searchParams = new URLSearchParams(window.location.search);
				var userType = (searchParams.get('type') || 'client').toLowerCase();
				if (userType !== 'driver' && userType !== 'client') userType = 'client';
				// Afficher une indication dans le message
				var typeLabel = userType === 'driver' ? 'Chauffeur' : 'Client';
				document.getElementById('message').textContent = 'Compte d√©tect√©: ' + typeLabel + ' ‚Ä¢ Pr√©paration du formulaire de r√©initialisation...';

				// R√©cup√©rer la config Supabase (tentatives multi-sources adapt√©es √† Netlify/Vite)
				function getMeta(name) {
					var el = document.querySelector('meta[name=\"' + name + '\"]');
					return el ? el.getAttribute('content') : '';
				}

				// Priorit√©s:
				// 1) Query params ajout√©s par l'app mobile (sbUrl, sbAnon) - √©vite d'exposer des variables globales
				// 2) Variables globales inject√©es (window.__SUPABASE_*__)
				// 3) Variables Vite expos√©es au runtime si inject√©es (window.VITE_* ou window.env.VITE_*)
				// 4) Meta tags (ex: <meta name=\"vite-supabase-url\" content=\"...\">)
				// Pas de hardcode par d√©faut: si manquant, on affiche une erreur contr√¥l√©e
				var search = new URLSearchParams(window.location.search);
				var sbUrlFromQuery = search.get('sbUrl');
				var sbAnonFromQuery = search.get('sbAnon');
				var SUPABASE_URL =
					sbUrlFromQuery ||
					window.__SUPABASE_URL__ ||
					window.VITE_SUPABASE_URL ||
					(window.env && window.env.VITE_SUPABASE_URL) ||
					getMeta('vite-supabase-url') ||
					'';

				var SUPABASE_ANON_KEY =
					sbAnonFromQuery ||
					window.__SUPABASE_ANON_KEY__ ||
					window.VITE_SUPABASE_ANON_KEY ||
					(window.env && window.env.VITE_SUPABASE_ANON_KEY) ||
					getMeta('vite-supabase-anon-key') ||
					'';

				if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
					console.warn('‚ö†Ô∏è Configuration Supabase incompl√®te (URL/Anon Key manquants).');
					// Ne jamais journaliser les valeurs sensibles; indiquer seulement les sources accept√©es
					console.warn('Sources accept√©es: sbUrl/sbAnon (query), window.__SUPABASE_*__, window.VITE_*/window.env.VITE_*, meta tags.');
					showError('Configuration Supabase manquante. R√©essayez depuis l\'application ou contactez le support.');
					return;
				}

				// Initialiser Supabase
				var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
					auth: {
						persistSession: true,
						detectSessionInUrl: true,
						autoRefreshToken: true,
					},
				});

				// √âtape 1: s'assurer que la session "recovery" est bien cr√©√©e
				bootstrapRecoveryPage();

            } catch (error) {
                console.error('‚ùå Erreur:', error);
				showError(error.message || 'Une erreur est survenue lors de l\'initialisation de la page.');
            }
            
			async function bootstrapRecoveryPage() {
				try {
					document.getElementById('message').textContent = 'V√©rification de votre lien de r√©initialisation...';

					// Laisser detectSessionInUrl agir un court instant
					await new Promise(r => setTimeout(r, 50));

					let { data: { session } } = await supabase.auth.getSession();
					if (!session) {
						// Fallback: extraire tokens apr√®s le DERNIER '#'
						const href = window.location.href;
						const idx = href.lastIndexOf('#');
						if (idx !== -1) {
							const hash = href.substring(idx + 1);
							const access = hash.match(/access_token=([^&]+)/)?.[1];
							const refresh = hash.match(/refresh_token=([^&]+)/)?.[1];

							if (access && refresh) {
								const { data, error } = await supabase.auth.setSession({
									access_token: decodeURIComponent(access),
									refresh_token: decodeURIComponent(refresh),
								});
								if (error) {
									throw error;
								}
								session = data.session;
							}
						}
					}

					if (!session) {
						showError('Session de r√©initialisation expir√©e. Veuillez demander un nouveau lien.');
						return;
					}

					document.getElementById('spinner').style.display = 'none';
					document.getElementById('message').textContent = 'Entrez votre nouveau mot de passe pour terminer la r√©initialisation.';
					document.getElementById('form').style.display = 'block';

					// Soumission du formulaire
					document.getElementById('form').addEventListener('submit', onSubmit);
				} catch (e) {
					console.error('Erreur bootstrap:', e);
					showError('Une erreur est survenue lors de la pr√©paration de la page.');
				}
			}

			async function onSubmit(e) {
				e.preventDefault();
				const pwd = document.getElementById('pwd').value;
				const pwd2 = document.getElementById('pwd2').value;

				if (!pwd || pwd.length < 8) {
					showError('Le mot de passe doit contenir au moins 8 caract√®res.');
					return;
				}
				if (pwd !== pwd2) {
					showError('Les deux mots de passe ne correspondent pas.');
					return;
				}

				try {
					document.getElementById('error').style.display = 'none';
					document.getElementById('message').textContent = 'Mise √† jour de votre mot de passe...';
					document.getElementById('spinner').style.display = 'block';

					const { error } = await supabase.auth.updateUser({ password: pwd });
					if (error) throw error;

					document.getElementById('spinner').style.display = 'none';
					document.getElementById('message').textContent = '';
					document.getElementById('form').style.display = 'none';
					document.getElementById('success').style.display = 'block';
				} catch (err) {
					console.error('updateUser error:', err);
					showError('Impossible de mettre √† jour le mot de passe. Le lien a peut-√™tre expir√©.');
				}
			}
            
            function showError(message) {
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = message;
				document.getElementById('message').textContent = 'Erreur';
				document.getElementById('spinner').style.display = 'none';
            }
        })();
    </script>
</body>
</html>

